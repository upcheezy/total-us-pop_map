<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Hello, map!</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
  <style>
    #map {
      height: 540px;
    }


    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) {}

    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {

      aside {
        height: 540px;
      }
    }

    /* Large devices (desktops, 992px and up) */
    @media (min-width: 992px) {}

    /* Extra large devices (large desktops, 1200px and up) */
    @media (min-width: 1200px) {}
  </style>
</head>

<body class="bg-dark">

  <div class="container-fluid">
    <header class="row text-white py-3">
      <div class="col mx-2">
        <h1 class="">Map title</h1>
      </div>
    </header>

    <section class="row">
      <div class="col-12 col-md-8 col-lg-9 px-0">
        <div id="map"></div>
      </div>
      <aside id="about" class="col-12 col-md-4 col-lg-3 text-white py-2 bg-secondary overflow-auto">
        <section>
          <h2>About this map</h2>
          <p>A fan brush is a fantastic piece of equipment. Use it. Make friends with it. We're not trying to teach you
            a thing to copy. We're just here to teach you a technique, then let you loose into the world. We'll put a
            happy little sky in here.</p>
          <p>We'll paint one happy little tree right here. The secret to doing anything is believing that you can do it.
            Anything that you believe you can do strong enough, you can do. Anything. As long as you believe. Let's make
            a nice big leafy tree.</p>
          <p>You are only limited by your imagination. We'll do another happy little painting. Work on one thing at a
            time. Don't get carried away - we have plenty of time. Look at them little rascals. We'll put all the little
            clouds in and let them dance around and have fun. You can spend all day playing with mountains.</p>
        </section>
      </aside>
    </section>
    <footer class="row text-white py-3">
      <div class="col mx-2">
        <ul class="list-unstyled">
          <li>author</li>
          <li>date</li>
          <li><a href="#">meta data</a></li>
        </ul>
      </div>
    </footer>
  </div>


  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/simple-statistics@5.2.1/dist/simple-statistics.min.js"></script>
  <script>
    var options = {
      center: [0, 180],
      zoom: 1.1,
      zoomSnap: .1
    }
    var map = L.map('map', options);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var attributeValue = "name",
            normValue = "pop";

    /// AJAX call to load county-level data
    $.getJSON("data/states_w_pop.json", function (data) {
      drawMap(data); // draw the map using GeoJSON data
    });

    function drawMap(data) {

      // create Leaflet data layer and add to map
      var dataLayer = L.geoJson(data, {
        style: function (feature) {
          // style counties with initial default path options
          return {
            color: '#dddddd',
            weight: 2,
            fillOpacity: 1,
            fillColor: '#1f78b4'
          };
        },
        onEachFeature: function (feature, layer) {

          // when mousing over a layer
          layer.on('mouseover', function () {

            // change the stroke color and bring that element to the front
            layer.setStyle({
              color: '#ff6e00'
            }).bringToFront();
          });

          // on mousing off layer
          layer.on('mouseout', function () {

            // reset the layer style to its original stroke color
            layer.setStyle({
              color: '#dddddd'
            });
          });
        }
      }).addTo(map);

      // fit the map's bounds and zoom level using the dataLayer extent
      map.fitBounds(dataLayer.getBounds(), {
        paddingTopLeft: [25, 25] // push off top left for sake of legend
      });

      // addUi(dataLayer); // add the UI controls
      updateMap(dataLayer);

    };

    function updateMap(dataLayer) {
      // get the class breaks for the current data attribute
      var breaks = getClassBreaks(dataLayer);

      // addLegend(breaks); // add the legend to the map using breaks
      // updateLegend(breaks);

      // loop through each county layer to update the color and tooltip info
      dataLayer.eachLayer(function (layer) {

        var props = layer.feature.properties;

        // console.log(props)

        // set the fill color of layer based on its normalized data value
        layer.setStyle({
          fillColor: getColor(props[normValue], breaks)
        });

        // assemble string sequence of info for tooltip (end line break with + operator)
        var tooltipInfo = "<b>" + props[normValue] +
          " State</b></br>" + props[attributeValue];

        // bind a tooltip to layer with county-specific information
        layer.bindTooltip(tooltipInfo, {
          // sticky property so tooltip follows the mouse
          sticky: true,
          tooltipAnchor: [200, 200]
        });

      });
    };

    function getClassBreaks(dataLayer) {

      // create empty Array for storing values
      var values = [];

      // loop through all the counties
      dataLayer.eachLayer(function (layer) {
        var value = layer.feature.properties[normValue];
        values.push(value); // push the normalized value for each layer into the Array
      });

      console.log(values)

      // determine similar clusters
      var clusters = ss.ckmeans(values, 5);

      // create an array of the lowest value within each cluster
      var breaks = clusters.map(function (cluster) {
        return [cluster[0], cluster.pop()];
      });

      //return array of arrays, e.g., [[0.24,0.25], [0.26, 0.37], etc]
      return breaks;

    }

    function getColor(d, breaks) {
      // function accepts a single normalized data attribute value
      // and uses a series of conditional statements to determine which
      // which color value to return to return to the function caller

      if (d <= breaks[0][1]) {
        return '#f1eef6';
      } else if (d <= breaks[1][1]) {
        return '#bdc9e1';
      } else if (d <= breaks[2][1]) {
        return '#74a9cf';
      } else if (d <= breaks[3][1]) {
        return '#2b8cbe'
      } else if (d <= breaks[4][1]) {
        return '#045a8d'
      }

    }

    function addLegend(breaks) {

      // create a new Leaflet control object, and position it top left
      var legendControl = L.control({
        position: 'topleft'
      });

      // when the legend is added to the map
      legendControl.onAdd = function (map) {

        // select a div element with an id attribute of legend
        var legend = L.DomUtil.get('legend');

        // disable scroll and click/touch on map when on legend
        L.DomEvent.disableScrollPropagation(legend);
        L.DomEvent.disableClickPropagation(legend);

        // return the selection to the method
        return legend;

      };

      // add the empty legend div to the map
      legendControl.addTo(map);

    }
  </script>
</body>

</html>